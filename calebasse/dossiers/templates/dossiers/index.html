{% extends "dossiers/base.html" %}
{% load url from future %}

{% block appbar %}
    <h2>Dossiers</h2>
    <a href="../..">Retourner à l'accueil</a>
    <button id="new-dossier">Nouveau dossier</button>
    <span>Dossiers: <span class="num">{{ stats.dossiers }}</span> -
        En contact: <span class="num">{{ stats.En_contact }}</span> - 
        Fin d'accueil: <span class="num">{{ stats.Fin_daccueil }}</span> -
        <span>En diagnostic: <span class="num">{{ stats.Diagnostic }}</span> - 
            En traitement: <span class="num">{{ stats.Traitement }}</span> - 
            Clos: <span class="num">{{ stats.Clos }}</span></span>
        <br>
        <br>&nbsp;
    </span>
{% endblock %}

{% block content %}
<div id="sidebar">
  <div>
    <form>
    <h3>Rechercher dans les dossiers</h3>
        <label>Nom <input name="last_name" type="text" value="{{ request.GET.last_name }}"></label>
        <label>Prénom <input name="first_name" type="text" value="{{ request.GET.first_name }}"></label>
        <label>Numéro de dossier <input name="paper_id" type="text" value="{{ request.GET.id }}"></label>
        <label>Numéro d'assuré social <input name="social_security_id" value="{{ request.GET.social_security_id }}" type="text"></label>
    <button id="search">Rechercher</button>
    <p id="search-results" style="display: none; "></p>
  </div>
  <div id="filtre">
    <h3>Filtres sur l'état</h3>
    <ul id="state_filters">
        <li><label for="id_states_0"><input checked="checked" type="checkbox" name="states" value="0" id="id_states_0" class="checkbox_state"> En contact</label></li>
        <li><label for="id_states_1"><input checked="checked" type="checkbox" name="states" value="1" id="id_states_1" class="checkbox_state"> Fin d'accueil</label></li>
        <li><label for="id_states_2"><input checked="checked" type="checkbox" name="states" value="2" id="id_states_2" class="checkbox_state"> En diagnostic</label></li>
        <li><label for="id_states_3"><input checked="checked" type="checkbox" name="states" value="3" id="id_states_3" class="checkbox_state"> En traitement</label></li>
        <li><label for="id_states_4"><input checked="checked" type="checkbox" name="states" value="4" id="id_states_4" class="checkbox_state"> Clos</label></li>
        <li><button id="btn_all_state" type="button">Tous</button> <button id="btn_none_state" type="button">Aucun</button></li>
    </ul>
    <h3>Afficher les dossiers</h3>
    <ul>
      <li><button>En pause facturation</button></li>
      <li><button>Une prolongation est nécessaire</button></li>
      <li><button>Prise en charge arrivant à expiration</button></li>
      <li><button>Prise en charge manquante ou expirée</button></li>
      <li><button>Eligibles pour un rediagnostic</button></li>
    </ul>
    </form>
  </div>
</div>
<div class="content">
  <table id="dossiers" class="main">
    <thead>
      <tr>
        <th colspan="2">N° dossier
        </th><th rowspan="2">Nom</th>
        <th rowspan="2">Prénom</th>
        <th rowspan="2">Date de naissance</th>
        <th rowspan="2">État du dossier</th>
        <th rowspan="2"><span title="Information à propos de la prise en charge">I</span> / <span title="Dossier en pause facturation">F</span></th>
        <th rowspan="2">Dernier acte</th>
        <th rowspan="2">Prochain rendez-vous</th>
      </tr>
      <tr>
        <th>papier</th>
        <th>inform.</th>
      </tr>
    </thead>
    <tbody>

      {% for patient_record in patient_records %}
      <tr>
        <td>{{ patient_record.object.paper_id|default_if_none:"" }}</td>
        <td>{{ patient_record.object.id }}</td>
        <td>{{ patient_record.object.last_name }}</td>
        <td>{{ patient_record.object.first_name }}</td>
        <td>{{ patient_record.object.birthdate|date:"d/m/Y" }}</td>
        <td>{{ patient_record.state }}</td>
        <td></td>
        <td>
            {% if patient_record.last_rdv %}
            {{ patient_record.last_rdv.start_datetime|date:"d/m/Y h:i" }}<br>
            {% for participant in patient_record.last_rdv.participants %}
            {{ participant.last_name }} - 
            {% endfor %}
            {{ patient_record.last_rdv.act_type }}
            {% endif %}
        </td>
        <td>
            {% if patient_record.next_rdv %}
            {{ patient_record.next_rdv.start_datetime|date:"d/m/Y h:i" }}<br>
            {% for participant in patient_record.next_rdv.participants %}
            {{ participant.last_name }} - 
            {% endfor %}
            {{ patient_record.next_rdv.act_type }}
            {% endif %}
        </td>
      </tr>
      {% endfor %}


    </tbody>
  </table>

  {% if not request.GET %}
  <div class="big-msg-info">
    Utilisez le formulaire de recherche sur la gauche de l'écran pour afficher
    les dossiers correspondants.
  </div>
  {% elif not patient_records %}
  <div>Pas de résultat pour votre recherche</div>
  {% endif %}

</div>
{% endblock %}

