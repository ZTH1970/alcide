{% extends "dossiers/base.html" %}
{% load url from future %}

{% block appbar %}
<h2><span class="lastname">{{ object.last_name }}</span> {{ object.first_name }} - Dossier {{ object.paper_id|default_if_none:"" }}</h2>
<a href="..">Retourner aux dossiers</a>
{% if not object.act_set.all %}
<button id="patientrecord-delete">Supprimer</button>
{% endif %}
{% endblock %}

{% block content %}
<div id="tabs">
  <ul>
    <li><a data-id="0" class="atabs" href="#tabs-1">Général</a></li>
    <li><a data-id="1" class="atabs" href="#tabs-2">Fiche administrative</a></li>
    <li><a data-id="2" class="atabs" href="#tabs-3">Adresses / contacts</a></li>
    {% if object.service.name == "CMPP" %}
    <li><a data-id="3"  class="atabs" href="#tabs-4">Prise en charge</a></li>
    {% endif %}
    {% if object.service.name == "SESSAD TED" or object.service.name == "SESSAD DYS" %}
    <li><a data-id="3" class="atabs" href="#tabs-4">Notifications</a></li>
    {% endif %}
    <li><a data-id="4" class="atabs" href="#tabs-5">Actes passés</a>
    <li><a data-id="5" class="atabs" href="#tabs-6">Prochains rendez-vous</a>
    <li><a data-id="6" class="atabs" href="#tabs-7">Socialisation</a>
    <li><a data-id="7" class="atabs" href="#tabs-8">Données à caractère médical</a>
  </ul>
  <div id="tabs-1"> <!-- Général -->
      {% include "dossiers/patientrecord_tab1.html" %}
  </div>

  <div id="tabs-2"> <!-- Fiche administrative -->
      {% include "dossiers/patientrecord_tab2.html" %}
  </div>

    <div id="tabs-3"> <!-- Adresses / Contacts -->
        <button id="new-address-btn">Nouvelle adresse</button>
        <button id="new-contact-btn">Nouveau contact</button>
    <form method="post" id="policyholder-form" class="patientrecordform">{% csrf_token %}
        {% for address in object.addresses.all %}
        <div class="frame">
            <h3>{{ address.number }} {{ address.street }}</h3>
            <div class="buttons">
                <button type="button" data-id="{{ address.id }}" class="del-address icon-minus" title="Supprimer"></button>
                <button type="button" data-id="{{ address.id }}" class="update-address-btn icon-edit" title="Modifier"></button>
            </div>
            <div class="right">
                <input type="checkbox" data-id="{{ address.id }}" class="place_of_life" {% if address.place_of_life %}checked{% endif %}>Lieu de vie</input>
            </div>
            <p>{{ address.zip_code }} {{ address.city }}</p>
            <p>{{ address.phone }}</p>
            {% for contact in address.patientcontact_set.all  %}
            <div class="contact{% if contact.id == object.id %} patient{% endif %}">
                <h4>{% if contact.gender == 1 %}M.{% elif contact.gender == 2 %}Mme{% endif %}
                    {{ contact.first_name }} <span class="lastname">{{ contact.last_name }}</span> {% if contact.id == object.id %} (PATIENT){% endif %}</h4>
                <div class="right">Assuré
                    <input type="radio"
                    {% if object.policyholder.id == contact.id %} checked="checked" {% endif %}
                    id="id_policyholder-policyholder_{{ contact.id }}"
                    value="{{ contact.id }}"
                    class="policyholder-radio"
                    name="policyholder-policyholder">
                    <button type="button" data-id="{{ contact.id }}" class="del-contact icon-minus" title="Supprimer"></button>
                    <button type="button" data-id="{{ contact.id }}" class="update-contact-btn icon-edit" title="Modifier"></button>
                </div>
                <div>
                    <ul>
                        {% if contact.email %}
                            <li>
                            <label>Courriel :</label>
                            {{ contact.email }}
                            </li>
                        {% endif %}
                        {% if contact.mobile %}
                            <li>
                            <label>Téléphone mobile :</label>
                            {{ contact.mobile }}
                            </li>
                        {% endif %}
                        {% if contact.contact_comment %}
                            <li>
                            <label>Commentaire :</label>
                            {{ contact.contact_comment }}
                            </li>
                        {% endif %}
                        <li><label>Données d'assuré social</label>
<!--                            <button class="blind">détails</button>-->
                            <ul>
                            <li>
                                {% if contact.social_security_id %}
                                    <label>Numéro d'assuré social :</label>
                                    {{ contact.social_security_id }}
                                {% else %}
                                    <label>Aucun numéro d'assuré social renseigné.</label>
                                {% endif %}
                            </li>
                            <li>
                                {% if contact.birthdate %}
                                    <label>Date de naissance :</label>
                                    {{ contact.birthdate }}
                                {% else %}
                                    <label>Aucune date de naissance renseignée.</label>
                                {% endif %}
                            </li>
                            <li>
                                {% if contact.begin_rights %}
                                    <label>Début de droits :</label>
                                    {{ contact.begin_rights }}
                                {% else %}
                                    <label>Aucun début de droits renseigné.</label>
                                {% endif %}
                            </li>
                            <li>
                                {% if contact.end_rights %}
                                    <label>Fin de droits :</label>
                                    {{ contact.end_rights }}
                                {% else %}
                                    <label>Aucune fin de droits renseignée.</label>
                                {% endif %}
                            </li>
                            <li>
                                {% if contact.health_center %}
                                    <label>Centre de santé :</label>
                                    {{ contact.health_center }}
                                {% else %}
                                    <label>Aucun centre de santé renseigné.</label>
                                {% endif %}
                            </li>
                            <li><label>Tiers-payant :</label>
                                {% if contact.thirdparty_payer %}
                                    Oui
                                {% else %}
                                    Non
                                {% endif %}
                            </li>
                            <li>
                                {% if contact.twinning_rank %}
                                    <label>Rang (gémellité) :</label>
                                    {{ contact.twinning_rank }}
                                {% else %}
                                    <label>Pas de gémellité.</label>
                                {% endif %}
                            </li>
                            </ul>
                        </li>
                    </ul>
                </div>
            </div>
            {% endfor %}
        </div>
        {% endfor %}
        <input id="submit-policyholder" type="submit" value="Submit" style="display: none;">
    </form>

    </div>

    <div id="tabs-4"> <!-- Prise en charge -->

    {% if object.service.name == "CMPP" %}
        <p>
        {% if can_rediag %}<button id="new-pcdiag-btn">Nouvelle PC diagnostic</button>{% endif %}
        <button id="new-pctrait-btn">Nouvelle PC traitement</button>
        </p>
        {% if hcs %}
            {% for hc in hcs %}
                {% if hc.cmpphealthcarediagnostic %}
                  <div id="patient-diag">
                    <div class="frame">
                      <h3>En diagnostic depuis le {{ hc.start_date }}</h3>
                      <ul>
                        <li><input size="4" value="{{ hc.cmpphealthcarediagnostic.act_number }}"/> actes prévus</li>
                        <li>{% if hc.get_nb_acts_cared %}<strong>{{ hc.get_nb_acts_cared }}</strong> actes déja facturés.{% else %}Aucun acte facturé.{% endif %}</li>
                      </ul>
                    </div>
                  </div>
                {% else %}
                  <div id="patient-traitement">
                    <div class="frame">
                      <h3>En traitement depuis le {{ hc.start_date }} jusqu'au {{ hc.end_date }}</h3>
                      <ul>
                        <li><input size="4" value="{{ hc.cmpphealthcaretreatment.act_number }}"/> actes prévus</li>
                        <li>{% if hc.get_nb_acts_cared %}<strong>{{ hc.get_nb_acts_cared }}</strong> actes déja facturés.{% else %}Aucun acte facturé.{% endif %}</li>
                      </ul>
                    </div>
                  </div>
                {% endif %}
            {% endfor %}
        {% endif %}
    {% endif %}
    {% if object.service.name == "SESSAD TED" or object.service.name == "SESSAD DYS" %}
        <button id="new-notification-btn">Nouvelle notification</button>
    {% endif %}


<!--      <div id="patient-diag">-->
<!--        <div class="frame">-->
<!--          <h3>En diagnostic depuis le 11 juin 2012</h3>-->
<!--          <ul>-->
<!--            <li><input size="4" value="6"/> actes prévus</li>-->
<!--            <li><strong>3</strong> actes réalisés dont <strong>2</strong> facturés <button class="blind">détails</button>-->
<!--            <ul>-->
<!--              <li>Facturation <strong>28</strong> (assuré: Sophie Fonfec) - <strong>2</strong> actes-->
<!--              <ul>-->
<!--                <li>Accueil le 11 juin 2012 - 9h00 - 45 minutes - Bob Leponge</li>-->
<!--                <li>Dialogue le 12 juin 2012 - 10h00 - 30 minutes - Bob Leponge</li>-->
<!--              </ul></li>-->
<!--              <li>Non facturé - <strong>1 acte</strong>-->
<!--              <ul>-->
<!--                <li>Dialogue le 13 juin 2012 - 11h00 - 45 minutes - Sandy Kilo</li>-->
<!--              </ul></li>-->
<!--            </ul>-->
<!--            </li>-->
<!--          </ul>-->
<!--        </div>-->
<!--      </div>-->

<!--      <div id="patient-traitement">-->
<!--        <div class="frame">-->
<!--          <h3>En diagnostic depuis le 6 mars 2012</h3>-->
<!--          <ul>-->
<!--            <li><strong>6</strong> actes réalisés et facturés <button class="blind">détails</button>-->
<!--            <ul>-->
<!--              <li>Facturation <strong>28</strong> (assuré: Sophie Fonfec) - <strong>6</strong> actes-->
<!--              <ul>-->
<!--                <li>...</li>-->
<!--              </ul></li>-->
<!--            </ul>-->
<!--            </li>-->
<!--          </ul>-->
<!--        </div>-->

<!--        <div class="frame">-->
<!--          <h3>En traitement depuis le 11 juin 2012</h3>-->
<!--          <ul>-->
<!--            <li><strong>4</strong> actes réalisés <button class="blind">détails</button>-->
<!--            <ul><li>...</li></ul>-->
<!--            </li>-->
<!--            <li>Pas de prise en charge - <button id="add-prise-en-charge-btn">Ajouter une prise en charge</button></li>-->
<!--          </ul>-->
<!--        </div>-->

<!--      </div>-->

<!--      <div id="patient-traitement-charge" style="display: none;">-->

<!--        <div class="frame">-->
<!--          <h3>En diagnostic depuis le 2 avril 2008</h3>-->
<!--          <ul>-->
<!--            <li><strong>3</strong> actes réalisés et facturés <button class="blind">détails</button>-->
<!--            <ul>-->
<!--              <li>Facturation <strong>28</strong> (assuré: Sophie Fonfec) - <strong>3</strong> actes-->
<!--              <ul>-->
<!--                <li>...</li>-->
<!--              </ul></li>-->
<!--            </ul>-->
<!--            </li>-->
<!--          </ul>-->
<!--        </div>-->

<!--        <div class="frame">-->
<!--          <h3>En diagnostic depuis le 5 octobre 2010</h3>-->
<!--          <ul>-->
<!--            <li><strong>6</strong> actes réalisés et facturés <button class="blind">détails</button>-->
<!--            <ul>-->
<!--              <li>Facturation <strong>28</strong> (assuré: Sophie Fonfec) - <strong>6</strong> actes-->
<!--              <ul>-->
<!--                <li>...</li>-->
<!--              </ul></li>-->
<!--            </ul>-->
<!--            </li>-->
<!--          </ul>-->
<!--        </div>-->

<!--        <div class="frame">-->
<!--          <h3>En traitement depuis le 12 décembre 2010</h3>-->
<!--          <ul>-->
<!--            <li>Prise en charge depuis le 12 décembre 2010-->
<!--            <ul>-->
<!--              <li><strong>30</strong> actes réalisés et facturés <button class="blind">détails</button>-->
<!--              <ul><li>...</li></ul></li>-->
<!--              <li><strong>10</strong> actes réalisés et facturés en prolongation <button class="blind">détails</button>-->
<!--              <ul><li>...</li></ul></li>-->
<!--              <li><strong>6</strong> actes réalisés et non pris en charge <button class="blind">détails</button>-->
<!--              <ul><li>...</li></ul></li>-->
<!--            </ul>-->
<!--            </li>-->
<!--            <li>Prise en charge depuis le 15 décembre 2011-->
<!--            <ul>-->
<!--              <li><strong>30</strong> actes réalisés et facturés <button class="blind">détails</button>-->
<!--              <ul><li>...</li></ul></li>-->
<!--              <li><strong>6</strong> actes réalisés non facturés <button class="blind">détails</button>-->
<!--              <ul><li>...</li></ul></li>-->
<!--              <li><button id="add-prolongation-btn">Ajouter une prolongation</button></li>-->
<!--            </ul>-->
<!--            </li>-->
<!--          </ul>-->
<!--        </div>-->


<!--      </div>-->

<!--      <div id="overlay">-->
<!--       <p>-->
<!--       Exemples pour cet onglet :-->
<!--        <a href="#" onclick="$('#patient-diag').show(); $('#patient-traitement').hide(); $('#patient-traitement-charge').hide();">Patient en diagnostic</a>-->
<!--        <a href="#" onclick="$('#patient-diag').hide(); $('#patient-traitement').show(); $('#patient-traitement-charge').hide();">Patient en traitement</a>-->
<!--        <a href="#" onclick="$('#patient-diag').hide(); $('#patient-traitement').hide(); $('#patient-traitement-charge').show();">Patient en traitement avec prise en charge</a>-->
<!--        </p>-->
<!--      </div>-->

    </div>

    <div id="tabs-5"> <!-- Actes passés -->
        {% for last_rdv, state in last_rdvs %}
        <div class="frame">
            <h3>{{ last_rdv.start_time|date:"d/m/y H:m" }} {{ last_rdv.event.eventact.act_type }}</h3>
            <ul>
            {% if last_rdv.event.eventact.doctors.all %}
            <li><label>Praticiens :</label>
            {% for doctor in last_rdv.event.eventact.doctors.all %}
            {{ doctor.first_name }} <span class="lastname">{{ doctor.last_name }}</span>
            {% endfor %}
            </li>
            {% endif %}
            {% if last_rdv.event.room %}
            <li>
            Salle : {{ last_rdv.event.room }}
            </li>
            {% endif %}
            <li>
            {% if last_rdv.event.eventact.convocation_sent %}
            Convocation envoyé
            {% else %}
            Convocation non envoyé
            {% endif %}
            </li>
            <li>{% if state %}<strong>{{ state.state_name }}</strong>, le {{ state.created }} par {{ state.author }}
            {% else %}
              Non pointé.
            {% endif %}
            </li>
        </ul>
        </div>
        {% endfor %}
    </div>

    <div id="tabs-6"> <!-- Prochains rendez-vous -->
        {% for next_rdv, state in next_rdvs %}
        <div class="frame">
            <h3>{{ next_rdv.start_time|date:"d/m/y H:m" }} {{ next_rdv.event.eventact.act_type }}</h3>
            <ul>
            {% if last_rdv.event.eventact.doctors.all %}
            <li><label>Praticiens :</label>
            {% for doctor in last_rdv.event.eventact.doctors.all %}
            {{ doctor.first_name }} <span class="lastname">{{ doctor.last_name }}</span>
            {% endfor %}
            </li>
            {% endif %}
            {% if next_rdv.event.room %}
            <li>
            Salle : {{ next_rdv.event.room }}
            </li>
            {% endif %}
            <li>
            {% if next_rdv.event.eventact.convocation_sent %}
            Convocation envoyé
            {% else %}
            Convocation non envoyé
            {% endif %}
            </li>
            <li>{% if state %}<strong>{{ state.state_name }}</strong>, le {{ state.created }} par {{ state.author }}
            {% else %}
              Non pointé.
            {% endif %}
            </li>
        </ul>
        </div>
        {% endfor %}
    </div>

    <div id="tabs-7">
    </div>

    <div id="tabs-8">
    </div>
  </div>
</div>
{% endblock %}

{% block dialogs %}
<div id="ajax-dlg" style="display: none;"></div>
<div id="change-record" style="display: none;" data-id="{{ object.id }}" data-service-id="{{ service_id }}">
 </div>

  <div id="dossier-histo-dlg" style="display: none;">
   <dl>
    {% for state in states %}
    <dt><b>{{ state.date_selected|date:"d/m/Y" }}</b> <small>(date info: {{ state.created|date:"d/m/Y" }})</small></dt>
    <dd>
    <p><b>{{ state.status.name }}</b>; <label>commentaire:</label> {{ state.comment }}</p>
    <p>changement par {{ state.author }}</p>
    </dd>
    {% endfor%}
   </dl>
  </div>



  <div id="add-prise-en-charge-dlg" style="display: none;">
   <div>
    <label for="id_partir">À partir du :</label>
    <input id="id_partir" class="partir" name="partir" size="10" value="11/06/2012"/>
   </div>
   <div>
    <label for="id_pour">Pour :</label>
    <input id="id_pour" class="pour" name="pour" size="4" value="30"/> séances
   </div>
  </div>

  <div id="add-prolongation-dlg" style="display: none;">
   <div>
    <label for="id_pour">Pour :</label>
    <input id="id_pour" class="pour" name="pour" size="4" value="10"/> actes
   </div>
  </div>

<div id="finaccueil-patientrecord-dialog" title="Patient en fin d'accueil">
  <div id="finaccueil-patientrecord-dialog-content">
  </div>
  <form method="post" action="finaccueil-patientrecord/">
    {% csrf_token %}
    <input type="hidden" name="Close" value="1">
  </form>
</div>

{% endblock %}
