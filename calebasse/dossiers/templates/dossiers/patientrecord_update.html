{% extends "dossiers/base.html" %}
{% load url from future %}

{% block appbar %}
<h2><span class="lastname">{{ object.last_name }}</span> {{ object.first_name }} - Dossier {{ object.paper_id|default_if_none:"" }}</h2>
<a href="..">Retourner aux dossiers</a>
{% if not object.act_set.all %}
<button id="patientrecord-delete">Supprimer</button>
{% endif %}
{% endblock %}

{% block content %}
<div id="tabs">
  <ul>
    <li><a href="#tabs-1">Général</a></li>
    <li><a href="#tabs-2">Fiche administrative</a></li>
    <li><a href="#tabs-3">Adresses / contacts</a></li>
    {% if object.service.name == "CMPP" %}<li><a href="#tabs-4">Prise en charge</a></li>{% endif %}
    {% if object.service.name == "SESSAD TED" or object.service.name == "SESSAD DYS" %}<li><a href="#tabs-4">Notifications</a></li>{% endif %}
    <li><a href="#tabs-5">Actes passés</a>
    <li><a href="#tabs-6">Prochains rendez-vous</a>
    <li><a href="#tabs-7">Socialisation</a>
    <li><a href="#tabs-8">Données à caractère médical</a>
  </ul>
  <div id="tabs-1"> <!-- Général -->
    <form method="post" id="general-form" class="patientrecordform">
    {% csrf_token %}
    <div class="left">
      <ul>
          <li><label>N° dossier papier :</label> {{ object.paper_id|default_if_none:"" }} <button>✍</button></li>
        <li><label>N° dossier informatique :</label>{{ object.id }}</li>
        <li><label>Nom :</label> <span class="lastname">{{ object.last_name }}</span></li>
        <li><label>Prénom :</label> {{ object.first_name }}</li>
        <li><label>Date de naissance :</label> {{ object.birthdate|date:"d/m/Y" }}</li>
        <li><label>Lieux de vie :</label>
        <ul>
          {% for address in object.addresses.all %}
          <li>{{ address.number }} {{ address.street }}, {{ address.city }} - {{ address.phone }} </li>
          {% endfor %}

        </ul></li>
        <li><label>Date d'inscription :</label> {{ object.created|date:"d/m/Y" }}</li>
        <li><label>Lieu de socialisation :</label> {{ object.school|default_if_none:"" }}</li>
        <li><label>Commentaire :</label><br/>
        {{ forms.general.comment }}
        <button id="btn-maj">Mettre à jour</button></li>
      </ul>
    </div>
    <div class="right">
      <ul>
          <li><label>Dernier acte :</label>
          {% if last_rdv %}
          {{ last_rdv.start_datetime|date:"d/m/Y" }} -
          {% for participant in last_rdv.participants %}
          <span class="lastname">{{ participant.last_name }}</span> -
          {% endfor %}
          {{ last_rdv.act_type }}
          {% endif %}
          </li>
          <li><label>Prochain rendez-vous :</label>
          {% if next_rdv %}
          {{ next_rdv.start_datetime|date:"d/m/Y" }} -
          {% for participant in next_rdv.participants %}
          {{ participant.next_name }} -
          {% endfor %}
          {{ next_rdv.act_type }}
          {% endif %}
          </li>
      </ul>
      <div class="etat">
          <h4>État courant du dossier :  {{ current_state.status.name.lower }}</h4>
          <p>depuis le : {{ current_state.date_selected|date:"d/m/Y" }}</p>
          <p><label>Commentaire :</label>{{ object.last_state.comment|default_if_none:"" }}</p>
          {% for state in status %}
          <button type="button" id="{{ state.0 }}">{{ state.1 }}</button>
          {% endfor %}
        <button type="button" id="patientrecord-history">Historique</button><br/>
        <hr/>
        <p id="pause-msg" style="display: none; font-size: 10px;">Pause facturation mise à jour</p>
        {{ forms.general.pause.label_tag }} : {{ forms.general.pause }}
        <!-- 3/6 diagnostics -->
      </div>
        </form>

      <!-- <div class="notifs">
        <h4>Notifications</h4>
        <ul>
          <li>Dossier en pause facturation <button>Sortir</button></li>
      </ul>
  </div> -->

    </div>
    <br style="clear:both"/>
  </div>

  <div id="tabs-2"> <!-- Fiche administrative -->
    <form method="post" id="id-form">
    {% csrf_token %}
    <div class="frame inline">
      <h3>État civil</h3>
      <button class="save">✔</button>
      <p>
      {% for field in forms.id %}
      {{ field.errors }}
      {% endfor %}
      </p>
      <p>
      {{ forms.id.last_name.label_tag }} : <span class="lastname">{{ forms.id.last_name }}</span>
      {{ forms.id.first_name.label_tag }} : {{ forms.id.first_name }}
      </p>
      <p>
      {{ forms.id.birthdate.label_tag }} : {{ forms.id.birthdate }}
      {{ forms.id.gender.label_tag }} : {{ forms.id.gender }}
      {{ forms.id.nationality.label_tag }} : {{ forms.id.nationality }}
      </p>
      <input type="hidden"  name="tab"  value="1">
    </div>
  </form>


    <form method="post" id="physiology-form" class="patientrecordform">
    {% csrf_token %}
    <div class="frame inline">
      <h3>Physiologie</h3>
      <button class="save">✔</button>
      <p>
      {% for field in forms.physiology %}
      {{ field.errors }}
      {% endfor %}
      </p>
      <p>
      {% for field in forms.physiology %}
      {{ field.label_tag  }} : {{ field }}
      {% endfor %}
      </p>
      <input type="hidden"  name="tab"  value="1">
    </div>
  </form>

    <form method="post" id="inscription-form" class="patientrecordform">
    {% csrf_token %}
    <div class="frame inline">
      <h3>Inscription</h3>
      <button class="save">✔</button>
      <p>
      {% for field in forms.inscription %}
      {{ field.label_tag  }} : {{ field }}
      <button type="button"
          class="dialog-button"
          data-url="../../ressources/{{ field.name }}/new/ #form-content"
          data-default-button="Ajouter"
          data-next-url="{{ request.get_full_path }}#tab=1"
          title="Ajouter un {{ field.label.lower }}"
          type="button">+</button>
      {% endfor %}
      </p>
      <input type="hidden"  name="tab"  value="1">
    </div>
  </form>

    <form method="post" id="family-form" class="patientrecordform">
    {% csrf_token %}
    <div class="frame inline">
        <h3>Famille</h3>
      <button class="save">✔</button>
      <p>
      {% for field in forms.family %}
      {{ field.errors }}
      {% endfor %}
      </p>
      <p>
      {{ forms.family.sibship_place.label_tag  }} : {{ forms.family.sibship_place }}
      {{ forms.family.nb_children_family.label_tag  }} : {{ forms.family.nb_children_family }}
      <label>Rang (gémellité) :  </label> {{ object.twinning_rank|default_if_none:"Aucun" }}
      </p>
      <p>
      {{ forms.family.parental_authority.label_tag  }} : {{ forms.family.parental_authority }}
      <button type="button"
          class="dialog-button"
          data-url="../../ressources/parentalauthoritytype/new/ #form-content"
          data-default-button="Ajouter"
          data-next-url="{{ request.get_full_path }}#tab=1"
          title="Ajouter un type d'autorité parentale">+</button>
      {{ forms.family.family_situation.label_tag  }} : {{ forms.family.family_situation }}
      <button type="button"
          class="dialog-button"
          data-url="../../ressources/familysituationtype/new/ #form-content"
          data-default-button="Ajouter"
          data-next-url="{{ request.get_full_path }}#tab=1"
          title="Ajouter un type de situation familiale">+</button>
      {{ forms.family.child_custody.label_tag  }} : {{ forms.family.child_custody }}
      <button type="button"
          class="dialog-button"
          data-url="../../ressources/parentalcustodytype/new/ #form-content"
          data-default-button="Ajouter"
          data-next-url="{{ request.get_full_path }}#tab=1"
          title="Ajouter un type de garde parentale">+</button>
      </p>
      <input type="hidden"  name="tab"  value="1">
    </div>
    </form>

    <form method="post" id="transport-form" class="patientrecordform">
    {% csrf_token %}
    <div class="frame inline">
      <h3>Transport</h3>
      <button class="save">✔</button>
      <p>
      {% for field in forms.transport %}
      {{ field.label_tag  }} : {{ field }}
      <button type="button"
          class="dialog-button"
          data-url="../../ressources/{{ field.name }}/new/ #form-content"
          data-default-button="Ajouter"
          data-next-url="{{ request.get_full_path }}#tab=1"
          title="Ajouter un {{ field.label.lower }}">+</button>
      {% endfor %}
      </p>
      <table>
        <tr><td><button type="button">Attestation</button></td> <td><button type="button">Prescription</td></tr>
          <tr><td>Dernière attestation le 25/07/2012 <button>Historique</button></td>
            <td>Dernière prescription le 25/07/2012 <button>Historique</button></td></tr>
        </table>
      <input type="hidden"  name="tab"  value="1">
      </div>
    </form>

    <form method="post" id="followup-form" class="patientrecordform">{% csrf_token %}
      <div class="frame inline">
        <h3>Suivi du patient</h3>
        <button class="save">✔</button>
        <p>
        {{ forms.followup.coordinators.label_tag  }} : {{ forms.followup.coordinators }}
        </p>
        <p>
        {{ forms.followup.externaldoctor.label_tag  }} : {{ forms.followup.externaldoctor }}
        <button type="button">+</button>
        {{ forms.followup.externalintervener.label_tag  }} : {{ forms.followup.externalintervener }}
        <button type="button">+</button>
        </p>
      <input type="hidden"  name="tab"  value="1">
      </div>
    </form>

    </div>

    <div id="tabs-3"> <!-- Adresses / Contacts -->
        <button id="new-address-btn">Nouvelle adresse</button>
        <button id="new-contact-btn">Nouveau contact</button>
      {% for address in object.addresses.all %}
      <div class="frame">
          <h3>{{ address.number }} {{ address.street }}</h3>
        <div class="buttons"><button>➖</button> <button>✍</button></div>
        <div class="right">
          <input type="checkbox" checked>Lieu de vie</input>
        </div>
        <p>{{ address.zip_code }} {{ address.city }}</p>
        <p>{{ address.phone }}</p>
        {% for contact in address.patientcontact_set.all  %}
        <div class="contact{% if contact.id == object.id %} patient{% endif %}">
            <h4>{% if contact.gender == 1 %}M.{% else %}Mme{% endif %}
                {{ contact.display_name }} {% if contact.id == object.id %} (PATIENT){% endif %}</h4>
          <div class="right">
            <input type="radio" name="radio-assure" checked="checked">Assuré</input>
            <button>➖</button> <button>✍</button>
          </div>
          <p>{{ contact.social_security_id }}</p>
          <p>{{ contact.mobile }}</p>
      </div>
      {% endfor %}
      {% endfor %}

    </div>

    <div id="tabs-4"> <!-- Prise en charge -->
      <div id="patient-diag" style="display: none;">
        <div class="frame">
          <h3>En diagnostic depuis le 11 juin 2012</h3>
          <ul>
            <li><input size="4" value="6"/> actes prévus</li>
            <li><strong>3</strong> actes réalisés dont <strong>2</strong> facturés <button class="blind">détails</button>
            <ul>
              <li>Facturation <strong>28</strong> (assuré: Sophie Fonfec) - <strong>2</strong> actes
              <ul>
                <li>Accueil le 11 juin 2012 - 9h00 - 45 minutes - Bob Leponge</li>
                <li>Dialogue le 12 juin 2012 - 10h00 - 30 minutes - Bob Leponge</li>
              </ul></li>
              <li>Non facturé - <strong>1 acte</strong>
              <ul>
                <li>Dialogue le 13 juin 2012 - 11h00 - 45 minutes - Sandy Kilo</li>
              </ul></li>
            </ul>
            </li>
          </ul>
        </div>
      </div>

      <div id="patient-traitement" style="display: none;">
        <div class="frame">
          <h3>En diagnostic depuis le 6 mars 2012</h3>
          <ul>
            <li><strong>6</strong> actes réalisés et facturés <button class="blind">détails</button>
            <ul>
              <li>Facturation <strong>28</strong> (assuré: Sophie Fonfec) - <strong>6</strong> actes
              <ul>
                <li>...</li>
              </ul></li>
            </ul>
            </li>
          </ul>
        </div>

        <div class="frame">
          <h3>En traitement depuis le 11 juin 2012</h3>
          <ul>
            <li><strong>4</strong> actes réalisés <button class="blind">détails</button>
            <ul><li>...</li></ul>
            </li>
            <li>Pas de prise en charge - <button id="add-prise-en-charge-btn">Ajouter une prise en charge</button></li>
          </ul>
        </div>

      </div>

      <div id="patient-traitement-charge" style="display: none;">

        <div class="frame">
          <h3>En diagnostic depuis le 2 avril 2008</h3>
          <ul>
            <li><strong>3</strong> actes réalisés et facturés <button class="blind">détails</button>
            <ul>
              <li>Facturation <strong>28</strong> (assuré: Sophie Fonfec) - <strong>3</strong> actes
              <ul>
                <li>...</li>
              </ul></li>
            </ul>
            </li>
          </ul>
        </div>

        <div class="frame">
          <h3>En diagnostic depuis le 5 octobre 2010</h3>
          <ul>
            <li><strong>6</strong> actes réalisés et facturés <button class="blind">détails</button>
            <ul>
              <li>Facturation <strong>28</strong> (assuré: Sophie Fonfec) - <strong>6</strong> actes
              <ul>
                <li>...</li>
              </ul></li>
            </ul>
            </li>
          </ul>
        </div>

        <div class="frame">
          <h3>En traitement depuis le 12 décembre 2010</h3>
          <ul>
            <li>Prise en charge depuis le 12 décembre 2010
            <ul>
              <li><strong>30</strong> actes réalisés et facturés <button class="blind">détails</button>
              <ul><li>...</li></ul></li>
              <li><strong>10</strong> actes réalisés et facturés en prolongation <button class="blind">détails</button>
              <ul><li>...</li></ul></li>
              <li><strong>6</strong> actes réalisés et non pris en charge <button class="blind">détails</button>
              <ul><li>...</li></ul></li>
            </ul>
            </li>
            <li>Prise en charge depuis le 15 décembre 2011
            <ul>
              <li><strong>30</strong> actes réalisés et facturés <button class="blind">détails</button>
              <ul><li>...</li></ul></li>
              <li><strong>6</strong> actes réalisés non facturés <button class="blind">détails</button>
              <ul><li>...</li></ul></li>
              <li><button id="add-prolongation-btn">Ajouter une prolongation</button></li>
            </ul>
            </li>
          </ul>
        </div>


      </div>

<!--      <div id="overlay">-->
<!--        <p>-->
<!--        Exemples pour cet onglet :-->
<!--        <a href="#" onclick="$('#patient-diag').show(); $('#patient-traitement').hide(); $('#patient-traitement-charge').hide();">Patient en diagnostic</a> --->
<!--        <a href="#" onclick="$('#patient-diag').hide(); $('#patient-traitement').show(); $('#patient-traitement-charge').hide();">Patient en traitement</a> --->
<!--        <a href="#" onclick="$('#patient-diag').hide(); $('#patient-traitement').hide(); $('#patient-traitement-charge').show();">Patient en traitement avec prise en charge</a>-->
<!--        </p>-->
<!--      </div>-->

    </div>

    <div id="tabs-5">
    </div>

    <div id="tabs-6">
    </div>

    <div id="tabs-7">
    </div>

    <div id="tabs-8">
    </div>
  </div>
</div>
{% endblock %}

{% block dialogs %}
<div id="change-record" style="display: none;" data-id="{{ object.id }}" data-service-id="{{ service_id }}">
 </div>

 <div id="delete-record" style="display: none;">
  </div>
  <div id="dossier-histo-dlg" style="display: none;">
   <dl>
    {% for state in states %}
    <dt><b>{{ state.date_selected|date:"d/m/Y" }}</b> <small>(date info: {{ state.created|date:"d/m/Y" }})</small></dt>
    <dd>
    <p><b>{{ state.status.name }}</b>; <label>commentaire:</label> {{ state.comment }}</p>
    <p>changement par {{ state.author }}</p>
    </dd>
    {% endfor%}
   </dl>
  </div>

  <div id="new-address-dlg" style="display: none;"></div>
  <div id="new-contact-dlg" style="display: none;"></div>

  <div id="add-prise-en-charge-dlg" style="display: none;">
   <div>
    <label for="id_partir">À partir du :</label>
    <input id="id_partir" class="partir" name="partir" size="10" value="11/06/2012"/>
   </div>
   <div>
    <label for="id_pour">Pour :</label>
    <input id="id_pour" class="pour" name="pour" size="4" value="30"/> séances
   </div>
  </div>

  <div id="add-prolongation-dlg" style="display: none;">
   <div>
    <label for="id_pour">Pour :</label>
    <input id="id_pour" class="pour" name="pour" size="4" value="10"/> actes
   </div>
  </div>

<div id="finaccueil-patientrecord-dialog" title="Patient en fin d'accueil">
  <div id="finaccueil-patientrecord-dialog-content">
  </div>
  <form method="post" action="finaccueil-patientrecord/">
    {% csrf_token %}
    <input type="hidden" name="Close" value="1">
  </form>
</div>

{% endblock %}
