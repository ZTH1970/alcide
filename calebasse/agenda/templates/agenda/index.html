{% extends "calebasse/base.html" %}
{% load url from future %}
{% block extrascripts %}
    <script>
      function replace_anchor(url, anchor) {
        var splitted = url.split('#');
        return splitted[0] + '#' + encodeURI(anchor);
      }
      function extract_anchor() {
        if (window.location.href.indexOf('#') == -1) {
          return "";
        }
        var splitted = window.location.href.split('#');
        return decodeURI(splitted[1]).split(',');
      }
      function make_anchor() {
        return $.makeArray($('.person-item.active').map(function (v, i) { return '_' + $(i).attr('id'); })).join(',');
      }
      function toggle_worker(worker_selector) {
        $(worker_selector).toggleClass('active');
        // update the anchor
        var anchor = make_anchor();
        var new_uri = replace_anchor(window.location.href, anchor);
        console.log(new_uri);
        window.location.href = new_uri;
        $('a[href^="../"]').each(function (i, a) {
          $(a).attr('href', replace_anchor($(a).attr('href'), anchor));
        });

        var $target = $($(worker_selector).data('target'));
        $target.toggle();
        // var selected = $('#tabs').tabs('option', 'selected');
        // var length = $('#tabs').tabs('length');
        // alert($('.tabs').index($target.filter('.tabs')));
        if ($target.is(':visible')) {
          //$target.click();
        }
      }
  $(function() {
    $('#tabs').tabs();

    $('div.agenda > div').accordion({active: false, autoHeight: false});

    $('.person-item').on('click', function() {
      toggle_worker(this);
    });
    // select all anchors
    $.each(extract_anchor(), function (i, anchor) {
      $('#'+anchor.substr(1)).each(function (i, worker_selector) { toggle_worker(worker_selector); });
    });

    /* Gestion du filtre sur les utilisateurs */
		$('#filtre input').keyup(function() {
			var filtre = $(this).val();
      if (filtre) {
        $('#users li').each(function() {
          if ($(this).text().match(filtre)) {
            $(this).show();
          } else {
            $(this).hide();
          }
        });
      } else {
        $('#users li').show();
      }

		});
    $('#agenda-date').datepicker({
      dateFormat: "DD d MM yy",
      onClose: function(dateText, inst) {
        console.log('close');
      }
    });
    $('#agenda-date').on('change', function () {
      window.location.href=replace_anchor('../' + $(this).datepicker('getDate').toISOString().substr(0,10), make_anchor());
    });
		$('.date').datepicker({showOn: 'button'});
		$('#add-intervenant-btn').click(function() {
			var text = $(this).prev().val();
			$('#intervenants ul').append('<li><input type="checkbox" value="' + text + '" checked="checked">' + text + '</input></li>');
			$(this).prev().val('').focus();
			return false;
		});
		$('#newrdv').click(function() {
			$('#rdv').dialog({title: 'Nouveau rendez-vous',
				  width: '800px',
				  buttons: [ { text: "Fermer",
					       click: function() { $(this).dialog("close"); } },
					     { text: "Ajouter",
					       click: function() { $("#rdv form").submit(); } }]}
			);
			});
	});
	</script>
  <style>
    .person-item span { display: none; }
    .person-item.active span { display: inline; }
    #agenda-date { width: 20em; }
  </style>
{% endblock %}

{% block title %}{{ block.super }} - Agenda {% endblock %}

{% block header %}
  {{ block.super }}
  <span>Agenda - {{ service_name }}</spam>
{% endblock %}

{% block appbar %}
    <h2>Agenda</h2>
    <a href="accueil.html">Retourner à l'accueil</a>
    <button>Nouvel événement (autre)</button>
    <button id="newrdv">Nouveau rendez-vous patient</button>
{% endblock %}

{% block beforecontent %}
    <div id="extra-top-links">
     <a href="activite-du-service">Activité du service</a>
     —
     <a href="validation-des-actes">Validation des actes</a>
     —
     <a href="rendez-vous-periodiques">Rendez-vous périodiques</a>
    </div>


    <div id="users">
    <div id="filtre">
     <input type="text"/>
    </div>
    <dl>
     {% for workers_type in workers_types %}
     <dt>{{ workers_type.type }}</dt>
     <dd><ul>
       {% for worker in workers_type.workers %}
       <li id="selector-worker-{{worker.id}}" class="person-item" data-target=".worker-{{worker.id}}.agenda">{{ worker.display_name }} <span title="cliquer pour déselectionner">(-)</span></li>
       {% endfor %}
     </ul></dd>
     {% endfor %}
   </dl>
 </div>
{% endblock %}

{% block content %}
<div class="content">
   <div id="datesel">
     <a href="../{{ previous_month|date:"SHORT_DATE_FORMAT"}}">««</a>
     <a href="../{{ previous_day|date:"SHORT_DATE_FORMAT"}}">«</a>
   <!-- <span>Jeudi 5 juillet 2012</span> -->
   <input id="agenda-date" value="{{ date|date:"DATE_FORMAT" }}"/>
   <a href="../{{ next_day|date:"SHORT_DATE_FORMAT"}}">»</a>
   <a href="../{{ next_month|date:"SHORT_DATE_FORMAT"}}">»»</a>
   </div>

   <table>
    <tbody>
    <tr>
     <td id="dispos">
      Disponibilités
      <table>
        {% for start_time, quaters in disponibility.items %}
          <tr class="hour-mark">
              <td rowspan="4">{{ start_time }}:00</td>
              {% for quater in quaters|slice:":1" %}
                {% for value in quater %}
                <td class="worker-{{ value.id }} agenda {{ value.dispo }}" style="display: none; "></td>
                {% endfor %}
              {% endfor %}
          </tr>
          {% for quater in quaters|slice:"1:4" %}
            <tr>
              {% for value in quater %}
                <td class="worker-{{ value.id }} agenda {{ value.dispo }}" style="display: none; "></td>
              {% endfor %}
            </tr>
          {% endfor %}
        {% endfor %}
      </table>
     </td>

     <td id="agendas">
       <div id="tabs">
       <ul>
        {% for worker_agenda in workers_agenda %}
           <li><a href="#tabs-worker-{{ worker_agenda.worker.id }}" class="worker-{{ worker_agenda.worker.id }} agenda" style="display: none;">{{ worker_agenda.worker.display_name }}</a></li>
        {% endfor %}
       </ul>
       <div id="tabs-sandy-kilo" class="tabs agenda sandy-kilo agenda">
       <a class="print" href="#">Imprimer</a>
       <div>
        <h3 class="info"><span class="hour">08:00</span> — Arrivée</h3>
        <div></div>
        <h3 class="free"><span class="hour">08:00</span> — 120m
        </h3>
        <div><button class='booking' data-hour="08:00">Prendre un rendez-vous</button></div>
        <h3 class="busy-elsewhere convocation"><span class="hour">10:00</span> — 45m — John Doe — SK
         <span class="right">
         <span class="box camsp" title="CAMSP"></span>
         <img title="Une convocation a été envoyée" src="{{ STATIC_URL }}images/emblem-mail.png"/>
         <img title="Un commentaire existe" src="{{ STATIC_URL }}images/emblem-documents.png"/>
         <button>✍</button>
         <button>➖</button>
         </span>
        </h3>
        <div>
          <div class="textedit">
           <textarea>bla bla bla</textarea>
           <button>✔</button>
          </div>
          <a href="#">Dossier patient</a> -
          <a href="#">Prochains rendez-vous</a> -
          <a href="#">Convoquer patient</a>
        </div>
        <h3 class="busy-here"><span class="hour">10:45</span> — 45m — Jack Itchan — SK
         <span class="right">
           <img title="Un commentaire existe" src="{{ STATIC_URL }}images/emblem-documents.png"/>
         <button>✍</button>
         <button>➖</button>
         </span>
        </h3>
        <div>
          <div class="textedit">
           <textarea>bla bla bla</textarea>
           <button>✔</button>
          </div>
          <a href="#">Dossier patient</a> -
          <a href="#">Prochains rendez-vous</a> -
          <a href="#">Convoquer patient</a>
        </div>
        <h3 class="busy-elsewhere"><span class="hour">11:30</span> — 30m — Réunion — Salle S4</h3>
        <div>
          <div class="textedit">
           <textarea>bla bla bla</textarea>
           <button>✔</button>
          </div>
        </div>
        <h3 class="free"><span class="hour">12:00</span> — 30m</h3>
        <div></div>
        <h3 class="info"><span class="hour">12:30</span> — Départ</h3>
        <div></div>
       </div>
       </div>

       <div id="tabs-bob-leponge" class="tabs agenda bob-leponge">
       <a class="print" href="#">Imprimer</a>
       <div>
        <h3 class="info"><span class="hour">08:30</span> — Arrivée</h3>
        <div></div>
        <h3 class="free"><span class="hour">08:30</span> — 180m</h3>
        <div><button>Prendre un rendez-vous</button></div>
        <h3 class="busy-elsewhere"><span class="hour">11:30</span> — 30m — Réunion — Salle S4</h3>
        <div>
          <div class="textedit">
           <textarea>bla bla bla</textarea>
           <button>✔</button>
          </div>
        </div>
        <h3 class="free"><span class="hour">12:00</span> — 30m</h3>
        <div></div>
        <h3 class="info"><span class="hour">12:30</span> — Départ</h3>
        <div></div>
        <h3 class="info"><span class="hour">13:00</span> — Arrivée</h3>
        <div></div>
        <h3 class="free"><span class="hour">13:00</span> — 270m</h3>
        <div><button>Prendre un rendez-vous</button></div>
        <h3 class="info"><span class="hour">17:30</span> — Départ</h3>
        <div></div>
       </div>

       </div>

       </div>
     </td>
    </tr>
    </tbody>
   </table>
 </div>

{% endblock %}

{% block dialogs %}
  <div id="rdv" style="display: none;">
    <form method="post" action="{% url "nouveau-rdv" service=service date=date %}">
     {% with new_appointment_form as form %}
   <table><tr><td>
   <p>

   {{ form.date.label_tag }}
   {{ form.date }}
   </p>
   </td><td>
   <p>
   {{ form.time.label_tag }}
   {{ form.time }}
   </p>
   </td><td>
   <p>
   {{ form.duration.label_tag }}
   {{ form.duration }}
   </p>
   </td></tr>

   <tr>
   <td>
     <h4>{{ form.participants.label_tag }}</h4>
   <div id="intervenants">
     {{ form.participants }}
   </div>
   </td>
   <td>
     <h4>{{ form.patient.label_tag }}</h4>
     {{ form.patient }}
   </td>
   <td>

     <h4>{{ form.act_type.label_tag }}</h4>
     {{ form.act_type }}
   </td>
   </tr>
   </table>

   <hr/>
   <button>Configurer la périodicité</button>
   {% endwith %}
   </form>
 </div>
{% endblock %}
